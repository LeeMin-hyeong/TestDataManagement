# .github/workflows/issue_license.yml
name: Issue License (Manual)

on:
  workflow_dispatch:
    inputs:
      name:
        description: "Customer name"
        required: true
        type: string
      license_id:
        description: "License ID (e.g. TDM-2026-0001)"
        required: true
        type: string
      expires_at:
        description: "Expires at (ISO8601, optional)"
        required: false
        type: string
      product:
        description: "Product name"
        required: false
        default: "TestDataManagement"
        type: string

permissions:
  contents: read

jobs:
  issue:
    runs-on: windows-latest
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install cryptography

      - name: Write private key (from secret PEM)
        shell: pwsh
        run: |
          $keyPath = "license-keys/tdm_private_key.pem"
          New-Item -ItemType Directory -Force -Path "license-keys" | Out-Null

          $pem = "${{ secrets.TDM_PRIVATE_KEY }}"
          if (-not $pem) { throw "TDM_PRIVATE_KEY secret is empty." }

          $pem = $pem.Trim() -replace "`r`n", "`n"
          Set-Content -Path $keyPath -Value $pem -NoNewline -Encoding ascii

      - name: Write public key (from secret PEM)
        shell: pwsh
        run: |
          $keyPath = "license-keys/tdm_public_key.pem"
          New-Item -ItemType Directory -Force -Path "license-keys" | Out-Null

          $pem = "${{ secrets.TDM_PUBLIC_KEY }}"
          if (-not $pem) { throw "TDM_PUBLIC_KEY secret is empty." }

          $pem = $pem.Trim() -replace "`r`n", "`n"
          Set-Content -Path $keyPath -Value $pem -NoNewline -Encoding ascii

      - name: Issue license.json
        shell: pwsh
        run: |
          # issued_at = workflow execution time (UTC, ISO8601)
          $issuedAt = (Get-Date).ToUniversalTime().ToString("o")

          $args = @(
            "scripts/license_tools.py", "issue",
            "--private-key", "license-keys/tdm_private_key.pem",
            "--public-key", "license-keys/tdm_public_key.pem",
            "--name", "${{ inputs.name }}",
            "--license-id", "${{ inputs.license_id }}",
            "--product", "${{ inputs.product }}",
            "--issued-at", $issuedAt,
            "--out", "license.json"
          )

          if ("${{ inputs.expires_at }}") { $args += @("--expires-at", "${{ inputs.expires_at }}") }

          python @args

      - name: Cleanup keys
        if: always()
        shell: pwsh
        run: |
          Remove-Item -Force -ErrorAction SilentlyContinue "license-keys/tdm_private_key.pem"
          Remove-Item -Force -ErrorAction SilentlyContinue "license-keys/tdm_public_key.pem"

      - name: Upload license.json
        uses: actions/upload-artifact@v4
        with:
          name: license-json
          path: license.json
          if-no-files-found: error
