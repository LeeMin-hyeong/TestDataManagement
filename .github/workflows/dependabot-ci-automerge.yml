name: Dependabot PR - Build & Auto-merge (main)

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, ready_for_review ]

permissions:
  actions: read
  contents: write
  pull-requests: write

concurrency:
  group: dependabot-ci-automerge-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build:
    if: github.actor == 'dependabot[bot]'
    runs-on: windows-latest
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - uses: actions/checkout@v5

      # (선택) 메타데이터 받아서 셀레니움 변경인지 확인
      - name: Fetch Dependabot metadata
        id: meta
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify only Selenium changed
        shell: bash
        run: |
          # 셀레니움 관련 변경이면 통과, 아니면 실패 처리해 자동 머지 방지
          if [[ "${{ steps.meta.outputs.dependency-names }}" != *"selenium"* ]]; then
            echo "This PR is not updating selenium. Failing to block auto-merge."
            exit 1
          fi

      - name: Wait for selenium rollup workflow to finish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.event.pull_request.head.ref }}
        shell: bash
        run: |
          echo "Checking rollup workflow status for branch: $BRANCH"
          for i in {1..24}; do
            statuses="$(gh api "/repos/$REPO/actions/workflows/dependabot-selenium-rollup.yml/runs?branch=$BRANCH&event=pull_request_target&per_page=10" --jq '.workflow_runs[].status' || true)"

            if echo "$statuses" | grep -Eq 'queued|in_progress'; then
              echo "Rollup workflow still running (attempt $i/24). Waiting 5s..."
              sleep 5
              continue
            fi

            echo "No queued/in-progress rollup workflow found."
            break
          done

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: astral-sh/setup-uv@v6

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps (JS)
        run: npm ci

      - name: Project setup
        shell: pwsh
        run: |
          chcp 65001 > $null
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
          npm run setup

      - name: Build (no release)
        shell: pwsh
        run: |
          chcp 65001 > $null
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
          npm run build

  enable-automerge:
    needs: build
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
  
      - name: Enable auto-merge (squash)
        env:
          GH_TOKEN: ${{ secrets.AUTO_MERGE_PAT }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --squash --auto
